# Инструкция по установке и настройке

Эта инструкция поможет вам настроить среду разработки, собрать и загрузить прошивку на ваше устройство ESP32-H2.

## Требования

Для работы с проектом вам потребуется:

1. Установленная среда ESP-IDF (v5.0 или выше)
2. Микроконтроллер ESP32-H2 с поддержкой ZigBee
3. Два сервопривода
4. USB-кабель для подключения к компьютеру
5. Источник питания (батарея или внешнее питание)

## Установка ESP-IDF

### Windows

1. Скачайте установщик ESP-IDF с официального сайта:
   https://docs.espressif.com/projects/esp-idf/en/latest/esp32/get-started/windows-setup.html

2. Запустите установщик и следуйте инструкциям на экране.

3. После установки откройте PowerShell и выполните следующие команды:
   ```powershell
   cd %userprofile%
   $env:IDF_PATH = "C:\esp\esp-idf"
   $env:IDF_TOOLS_PATH = "C:\esp"
   C:\esp\esp-idf\install.ps1
   ```

4. Для настройки окружения при каждом запуске PowerShell выполняйте:
   ```powershell
   C:\esp\esp-idf\export.ps1
   ```

### Linux/macOS

1. Откройте терминал и выполните следующие команды:
   ```bash
   mkdir -p ~/esp
   cd ~/esp
   git clone --recursive https://github.com/espressif/esp-idf.git
   cd esp-idf
   ./install.sh esp32h2
   ```

2. Для настройки окружения при каждом запуске терминала выполняйте:
   ```bash
   . $HOME/esp/esp-idf/export.sh
   ```

## Подключение оборудования

1. Подключите сервоприводы к ESP32-H2:
   - Сервопривод для ручки окна: GPIO4
   - Сервопривод для зазора: GPIO5

2. Подключите источник питания для сервоприводов (обычно 5В).

3. Если используете батарейное питание, подключите вывод для измерения напряжения к GPIO0 (ADC0).

4. Подключите ESP32-H2 к компьютеру через USB-кабель.

## Сборка и загрузка проекта

1. Клонируйте или распакуйте проект в удобное место:
   ```bash
   git clone https://github.com/yourusername/esp32-h2-zigbee-window.git
   cd esp32-h2-zigbee-window
   ```

2. Настройте проект для ESP32-H2:
   ```bash
   idf.py set-target esp32h2
   ```

3. (Опционально) Выполните конфигурацию проекта:
   ```bash
   idf.py menuconfig
   ```
   Здесь вы можете настроить различные параметры, такие как:
   - Wi-Fi реквизиты (SSID и пароль)
   - URL сервера обновлений
   - Параметры ZigBee (PAN ID, канал)

4. Соберите проект:
   ```bash
   idf.py build
   ```

5. Загрузите прошивку на устройство:
   ```bash
   idf.py -p PORT flash
   ```
   Замените PORT на COM-порт вашего устройства (например, COM3 в Windows или /dev/ttyUSB0 в Linux).

6. Мониторинг логов устройства:
   ```bash
   idf.py -p PORT monitor
   ```

## Настройка ZigBee и интеграция с Яндекс Алисой

### Настройка ZigBee

1. После прошивки устройство автоматически перейдет в режим сопряжения ZigBee.

2. Используйте ZigBee-координатор (например, Zigbee2MQTT с CC2531/CC2652 или Home Assistant с Conbee II) для добавления устройства в сеть.

3. Устройство будет определено как "Window Covering" (Шторы/жалюзи в Яндекс Алисе).

### Интеграция с Яндекс Алисой

1. Установите Home Assistant (если еще не установлен):
   - Следуйте инструкции на сайте: https://www.home-assistant.io/installation/

2. Добавьте интеграцию Zigbee в Home Assistant:
   - Перейдите в Настройки -> Интеграции
   - Добавьте интеграцию Zigbee (Zigbee Home Automation или ZHA)
   - Подключите ZigBee-координатор

3. Настройте интеграцию с Яндекс Алисой:
   - Добавьте интеграцию Yandex Smart Home в Home Assistant
   - Следуйте инструкциям на экране для привязки аккаунта Яндекса

4. После завершения настройки устройство появится в приложении "Дом с Алисой" как "шторы".

### Настройка системы уведомлений

1. В Home Assistant перейдите в раздел Настройки -> Автоматизации и сценарии.

2. Создайте новую автоматизацию для обработки уведомлений:
   - **Триггер**: Выберите "Событие ZigBee" и укажите ваше устройство
   - **Условие**: Укажите необходимые условия, например, тип уведомления
   - **Действие**: Настройте отправку push-уведомления или выполнение других действий

3. Примеры автоматизаций:
   - **Оповещение о механическом сопротивлении**: Отправка уведомления в мобильное приложение
   - **Низкий заряд батареи**: Отправка уведомления и включение светового индикатора
   - **Изменение режима окна**: Обновление статуса в журнале событий

### Интеграция с другими голосовыми ассистентами

#### Google Assistant

1. В Home Assistant настройте интеграцию с Google Assistant:
   - Перейдите в Настройки -> Интеграции
   - Добавьте интеграцию Google Assistant
   - Настройте Google Cloud Project согласно инструкции
   - Привяжите ваш аккаунт Google

2. После настройки устройство появится в приложении Google Home.

#### Apple HomeKit

1. В Home Assistant настройте интеграцию с HomeKit:
   - Перейдите в Настройки -> Интеграции
   - Добавьте интеграцию HomeKit
   - Следуйте инструкциям для сопряжения

2. На устройстве iOS откройте приложение Home:
   - Отсканируйте QR-код из Home Assistant
   - Устройство появится в приложении Home

## Управление

- "Открыть окно" - поворот ручки на 90 градусов
- "Закрыть окно" - возврат ручки в исходное положение
- "Проветрить" - поворот ручки на 180 градусов
- "Открыть на X%" - настройка зазора окна (работает только когда окно открыто)

## Устранение неполадок

### Устройство не подключается к сети ZigBee

1. Убедитесь, что координатор ZigBee работает и находится в режиме сопряжения.
2. Перезагрузите устройство, удерживая кнопку BOOT (если она есть) во время сброса.
3. Проверьте логи устройства через монитор ESP-IDF.

### Сервоприводы не вращаются или работают некорректно

1. Проверьте подключение и питание сервоприводов.
2. Убедитесь, что пины GPIO настроены правильно.
3. Проверьте, что напряжение питания сервоприводов соответствует их требованиям (обычно 5В).

### Не работает интеграция с Яндекс Алисой

1. Убедитесь, что устройство корректно отображается в Home Assistant.
2. Проверьте, что интеграция с Яндекс Алисой настроена правильно.
3. Перезапустите Home Assistant и приложение "Дом с Алисой".

### Не приходят уведомления о событиях

1. Проверьте, что устройство подключено к сети ZigBee и отображается в Home Assistant.
2. Проверьте настройки автоматизаций в Home Assistant.
3. Убедитесь, что кластер тревог (Alarms) и диагностики (Diagnostics) корректно настроены.
4. Проверьте логи в Home Assistant для выявления проблем с обработкой событий.

## Дополнительная информация

- Документация ESP-IDF: https://docs.espressif.com/projects/esp-idf/en/latest/esp32h2/
- Документация ZigBee: https://zigbeealliance.org/developer_resources/
- Документация Home Assistant: https://www.home-assistant.io/docs/
- Документация Яндекс Алисы: https://yandex.ru/dev/dialogs/smart-home/
- Документация Google Assistant: https://developers.google.com/assistant/smarthome/overview
- Документация Apple HomeKit: https://developer.apple.com/homekit/

## Контакты для поддержки

- Email: your.email@example.com
- GitHub: https://github.com/yourusername/esp32-h2-zigbee-window/issues 