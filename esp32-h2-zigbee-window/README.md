# Умное устройство управления окнами на базе ESP32-H2 с ZigBee

Проект умного устройства для автоматизации окон с использованием микроконтроллера ESP32-H2 и протокола ZigBee 3.0. Позволяет управлять окном через голосовые ассистенты, такие как Яндекс Алиса.

## Возможности

- **Управление окном через два сервопривода:**
  - Поворот ручки окна (закрытие/открытие/проветривание)
  - Регулировка расстояния от окна до рамы (зазор)
- **Интеграция с Яндекс Алисой через ZigBee**
- **Поддержка OTA-обновлений**
- **Энергосбережение и защита от механических сбоев**
- **Сохранение состояния в энергонезависимой памяти**
- **Система уведомлений о состоянии устройства:**
  - Обнаружение механического сопротивления
  - Предупреждение о низком заряде батареи
  - Уведомления об изменении режима работы

## Функциональные возможности

- **Режимы работы окна**:
  - **Закрыто**: Ручка в положении 0° (вертикально вниз)
  - **Открыто**: Ручка в положении 90° (горизонтально)
  - **Проветривание**: Ручка в положении 180° (вертикально вверх)
- **Управление зазором**: Регулировка расстояния между окном и рамой (0-100%)
- **Интеграция с голосовыми ассистентами**: Управление через Яндекс Алису
- **Расширенные функции**:
  - OTA-обновления прошивки
  - Энергосбережение при работе от батареи
  - Мониторинг состояния батареи
  - Защита от механического сопротивления
  - Сохранение и восстановление состояния
  - Уведомления о событиях и ошибках

## Аппаратные требования

- ESP32-H2 с поддержкой ZigBee 3.0
- Два сервопривода:
  - Сервопривод для ручки окна (подключен к GPIO4)
  - Сервопривод для управления зазором (подключен к GPIO5)
- Дополнительные компоненты:
  - Канал АЦП для измерения напряжения батареи (GPIO0/ADC1_CH0)
  - GPIO для определения внешнего питания (GPIO6)
- ZigBee-координатор (для интеграции с Яндекс Алисой)

## Требования к программному обеспечению

- ESP-IDF v5.0 или выше
- Платформа для сборки проекта (Windows, Linux или macOS)
- В случае интеграции с голосовыми ассистентами: Home Assistant + ZigBee-координатор

## Сборка и загрузка

1. Установите ESP-IDF (см. [официальную документацию](https://docs.espressif.com/projects/esp-idf/en/latest/esp32/get-started/))
2. Клонируйте репозиторий:
   ```bash
   git clone https://github.com/yourusername/esp32-h2-zigbee-window.git
   cd esp32-h2-zigbee-window
   ```
3. Настройте проект для ESP32-H2:
   ```bash
   idf.py set-target esp32h2
   ```
4. Соберите проект:
   ```bash
   idf.py build
   ```
5. Загрузите прошивку на устройство:
   ```bash
   idf.py -p PORT flash
   ```
   (замените PORT на соответствующий COM-порт)
6. При необходимости мониторинг логов:
   ```bash
   idf.py -p PORT monitor
   ```

## Интеграция с Яндекс Алисой

1. Подключите ZigBee-координатор к Home Assistant
2. Включите режим сопряжения на устройстве (автоматически включается при запуске)
3. Добавьте устройство в Home Assistant через ZigBee-интеграцию
4. Настройте интеграцию Yandex Smart Home в Home Assistant
5. Устройство появится в приложении "Дом с Алисой" как "шторы"

**Голосовые команды:**
- "Алиса, открой окно в спальне"
- "Алиса, закрой окно на кухне"
- "Алиса, проветри комнату"
- "Алиса, открой окно в спальне на 50 процентов"

## Структура проекта

```
esp32-h2-zigbee-window/
├── components/                   # Компоненты проекта
│   └── esp_zigbee_lib/          # Библиотека ZigBee
│       ├── include/             # Заголовочные файлы библиотеки
│       │   └── esp_zigbee_lib.h # Основной заголовочный файл ZigBee
│       ├── esp_zigbee_lib.c     # Реализация библиотеки ZigBee
│       └── CMakeLists.txt       # Конфигурация сборки компонента
├── main/                        # Основной код проекта
│   ├── main.c                   # Главный файл приложения
│   ├── servo_control.c/h        # Управление сервоприводами
│   ├── zigbee_device.c/h        # Обработка ZigBee
│   ├── ota_update.c/h           # Модуль OTA-обновлений
│   ├── power_management.c/h     # Управление питанием
│   ├── state_management.c/h     # Управление состоянием
│   └── CMakeLists.txt           # Конфигурация сборки основного кода
├── CMakeLists.txt               # Главная конфигурация сборки
├── sdkconfig.defaults           # Настройки ESP-IDF по умолчанию
└── README.md                    # Документация проекта
```

## Лицензия

MIT 